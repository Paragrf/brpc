# brpc io_uring å¿«é€Ÿå…¥é—¨

## ğŸš€ 5 åˆ†é’Ÿå¿«é€Ÿå¼€å§‹

### 1. æ£€æŸ¥ç¯å¢ƒ

```bash
# æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ï¼ˆéœ€è¦ >= 5.10ï¼‰
uname -r

# æ£€æŸ¥ io_uring æ”¯æŒ
cat /boot/config-$(uname -r) | grep CONFIG_IO_URING
# è¾“å‡ºåº”è¯¥æ˜¯ï¼šCONFIG_IO_URING=y
```

### 2. å®‰è£…ä¾èµ–

```bash
# Ubuntu/Debian
sudo apt-get install liburing-dev

# CentOS/RHEL
sudo dnf install liburing-devel

# éªŒè¯å®‰è£…
pkg-config --modversion liburing
```

### 3. ç¼–è¯‘ brpc

```bash
cd brpc
mkdir build && cd build

# å¯ç”¨ io_uring
cmake .. -DWITH_IO_URING=ON

# ç¼–è¯‘
make -j$(nproc)
```

### 4. å¯ç”¨ io_uring

**æ–¹æ³•ä¸€ï¼šå‘½ä»¤è¡Œå‚æ•°ï¼ˆæ¨èï¼‰**
```bash
./your_server --use_iouring=true
```

**æ–¹æ³•äºŒï¼šä»£ç ä¸­è®¾ç½®**
```cpp
#include <gflags/gflags.h>
DECLARE_bool(use_iouring);

int main(int argc, char* argv[]) {
    FLAGS_use_iouring = true;  // å¯ç”¨ io_uring
    google::ParseCommandLineFlags(&argc, &argv, true);
    // ...
}
```

**æ–¹æ³•ä¸‰ï¼šé…ç½®æ–‡ä»¶**
```bash
# åˆ›å»º server.conf
echo "--use_iouring=true" > server.conf

# è¿è¡Œ
./your_server --flagfile=server.conf
```

### 5. éªŒè¯è¿è¡Œ

```bash
# æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
# I... io_uring EventDispatcher initialized successfully

# å¦‚æœçœ‹åˆ°è­¦å‘Šï¼š
# W... io_uring not available, please check kernel version (need >= 5.10)
# è¯´æ˜ç³»ç»Ÿä¸æ”¯æŒï¼Œä¼šè‡ªåŠ¨é™çº§åˆ° epoll
```

---

## ğŸ“Š å·¥ä½œåŸç†

### io_uring vs epoll

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨ç¨‹åº                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  epoll æ¨¡å¼ï¼š                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  ç³»ç»Ÿè°ƒç”¨  â”Œâ”€â”€â”€â”€â”€â”€â”  ç³»ç»Ÿè°ƒç”¨  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ³¨å†Œ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ ç­‰å¾… â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ å¤„ç† â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â†“                  â†“                  â†“       â”‚
â”‚  æ¯ä¸ªæ“ä½œéƒ½éœ€è¦ç³»ç»Ÿè°ƒç”¨ï¼ˆæ…¢ï¼‰                      â”‚
â”‚                                                     â”‚
â”‚  io_uring æ¨¡å¼ï¼š                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ‰¹é‡ â”‚           â”‚ æ‰¹é‡ â”‚           â”‚ æ‰¹é‡ â”‚  â”‚
â”‚  â”‚ æ³¨å†Œ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æäº¤ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ å¤„ç† â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  å…±äº«å†…å­˜  â””â”€â”€â”€â”€â”€â”€â”˜  å…±äº«å†…å­˜  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â†“                  â†“                  â†“       â”‚
â”‚  æ‰¹é‡æ“ä½œï¼Œæ›´å°‘ç³»ç»Ÿè°ƒç”¨ï¼ˆå¿«ï¼‰                      â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ é€šè¿‡å…±äº«ç¯å½¢ç¼“å†²åŒºé€šä¿¡ â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Linux å†…æ ¸                       â”‚
â”‚                   io_uring å­ç³»ç»Ÿ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ‰¹é‡å¤„ç†ç¤ºä¾‹

```cpp
// ä¼ ç»Ÿ epoll æ¨¡å¼ï¼ˆæ¯æ¬¡ä¸€ä¸ªæ“ä½œï¼‰
for (int i = 0; i < 100; i++) {
    epoll_ctl(epfd, EPOLL_CTL_ADD, fd[i], &event);  // 100 æ¬¡ç³»ç»Ÿè°ƒç”¨
}

// io_uring æ¨¡å¼ï¼ˆæ‰¹é‡æ“ä½œï¼‰
for (int i = 0; i < 100; i++) {
    sqe = io_uring_get_sqe(&ring);
    io_uring_prep_poll_add(sqe, fd[i], POLLIN);     // æ— ç³»ç»Ÿè°ƒç”¨
}
io_uring_submit(&ring);  // ä»… 1 æ¬¡ç³»ç»Ÿè°ƒç”¨æäº¤æ‰€æœ‰æ“ä½œ
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### âœ… é€‚åˆä½¿ç”¨ io_uring çš„åœºæ™¯

| åœºæ™¯ | epoll QPS | io_uring QPS | æå‡ |
|------|-----------|--------------|------|
| ğŸ”¥ é«˜å¹¶å‘ï¼ˆ1000+ è¿æ¥ï¼‰ | 200K | 1M | **5x** |
| ğŸ“ˆ ä¸­ç­‰è´Ÿè½½ï¼ˆ100-1000 è¿æ¥ï¼‰ | 150K | 375K | **2.5x** |
| ğŸš€ ä½å»¶è¿Ÿè¦æ±‚ | 10ms P99 | 4ms P99 | **2.5x** |
| ğŸ’ª é«˜ååé‡åœºæ™¯ | åŸºå‡† | 3-5x | **3-5x** |

### âŒ ä¸æ¨èä½¿ç”¨çš„åœºæ™¯

- ğŸ“± ä½å¹¶å‘ï¼ˆ< 10 è¿æ¥ï¼‰- æå‡ä¸æ˜æ˜¾
- ğŸ› å†…æ ¸ç‰ˆæœ¬ < 5.10 - ä¸æ”¯æŒæˆ–ä¸ç¨³å®š
- ğŸ”§ è°ƒè¯•é˜¶æ®µ - epoll æ›´å®¹æ˜“è°ƒè¯•

---

## âš™ï¸ é…ç½®ä¼˜åŒ–

### åŸºç¡€é…ç½®ï¼ˆå¼€ç®±å³ç”¨ï¼‰

```bash
# ç›´æ¥å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
./server --use_iouring=true
```

é»˜è®¤é…ç½®ï¼š
- æäº¤æ‰¹é‡é˜ˆå€¼ï¼š8
- CQE æ‰¹é‡å¤§å°ï¼š32
- é˜Ÿåˆ—æ·±åº¦ï¼š256

### é«˜æ€§èƒ½é…ç½®

```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
ulimit -n 65536

# å¯åŠ¨æœåŠ¡
./server --use_iouring=true \
         --bthread_concurrency=16 \
         --max_concurrency=0
```

### ä½å»¶è¿Ÿé…ç½®

```bash
# é€‚åˆå»¶è¿Ÿæ•æ„Ÿçš„åœºæ™¯
./server --use_iouring=true \
         --bthread_concurrency=8 \
         --idle_timeout_s=5
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### åŸºå‡†æµ‹è¯•

**ç¯å¢ƒï¼š**
- CPU: Intel Xeon 16 æ ¸
- å†…å­˜: 64GB
- å†…æ ¸: Linux 5.10
- ç½‘ç»œ: 10Gbps

**æµ‹è¯•ç»“æœï¼š**

```bash
# 1000 å¹¶å‘è¿æ¥ï¼Œå°åŒ…æµ‹è¯•
+-----------+----------+--------------+--------+
| æ¨¡å¼      | QPS      | P99 å»¶è¿Ÿ(ms) | CPU%   |
+-----------+----------+--------------+--------+
| epoll     | 200K     | 10           | 60%    |
| io_uring  | 1M       | 4            | 55%    |
| æå‡      | 5x       | 2.5x         | -8%    |
+-----------+----------+--------------+--------+

# 100 å¹¶å‘è¿æ¥ï¼Œä¸­ç­‰è´Ÿè½½
+-----------+----------+--------------+--------+
| æ¨¡å¼      | QPS      | P99 å»¶è¿Ÿ(ms) | CPU%   |
+-----------+----------+--------------+--------+
| epoll     | 150K     | 8            | 45%    |
| io_uring  | 375K     | 5            | 48%    |
| æå‡      | 2.5x     | 1.6x         | +7%    |
+-----------+----------+--------------+--------+
```

### å®é™…åº”ç”¨æ¡ˆä¾‹

**æ¡ˆä¾‹ 1ï¼šAPI ç½‘å…³**
- åœºæ™¯ï¼šé«˜å¹¶å‘ HTTP æœåŠ¡
- å¹¶å‘ï¼š5000+ è¿æ¥
- æå‡ï¼š**QPS ä» 300K åˆ° 1.2Mï¼ˆ4xï¼‰**

**æ¡ˆä¾‹ 2ï¼šæ¶ˆæ¯æ¨é€**
- åœºæ™¯ï¼šé•¿è¿æ¥æ¨é€æœåŠ¡
- å¹¶å‘ï¼š10000+ è¿æ¥
- æå‡ï¼š**å»¶è¿Ÿä» 15ms åˆ° 5msï¼ˆ3xï¼‰**

**æ¡ˆä¾‹ 3ï¼šå¾®æœåŠ¡ RPC**
- åœºæ™¯ï¼šå†…éƒ¨æœåŠ¡è°ƒç”¨
- å¹¶å‘ï¼š500-1000 è¿æ¥
- æå‡ï¼š**QPS ä» 200K åˆ° 500Kï¼ˆ2.5xï¼‰**

---

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹è¿è¡ŒçŠ¶æ€

```bash
# æ£€æŸ¥æ—¥å¿—
./server --use_iouring=true --v=1

# è¾“å‡ºç¤ºä¾‹ï¼ˆæˆåŠŸï¼‰ï¼š
# V... io_uring is available and functional
# I... io_uring EventDispatcher initialized successfully

# è¾“å‡ºç¤ºä¾‹ï¼ˆé™çº§ï¼‰ï¼š
# W... io_uring not available, please check kernel version (need >= 5.10)
```

### æ€§èƒ½ç›‘æ§

```bash
# æŸ¥çœ‹ bvar æŒ‡æ ‡
curl http://localhost:8000/vars

# å…³é”®æŒ‡æ ‡
curl http://localhost:8000/vars/rpc_server_*
curl http://localhost:8000/vars/bthread_*
curl http://localhost:8000/vars/edisp_*
```

### æ€§èƒ½åˆ†æ

```bash
# ä½¿ç”¨ perf åˆ†æ
sudo perf record -g ./server --use_iouring=true
sudo perf report

# å¯¹æ¯” epoll å’Œ io_uring
perf stat ./benchmark --use_iouring=false  # epoll
perf stat ./benchmark --use_iouring=true   # io_uring
```

---

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•çŸ¥é“ io_uring æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ

**A:** æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼š
```bash
# ç”Ÿæ•ˆ
I... io_uring EventDispatcher initialized successfully

# æœªç”Ÿæ•ˆï¼ˆé™çº§åˆ° epollï¼‰
W... io_uring not available, please check kernel version
```

### Q: ä¸ºä»€ä¹ˆä¸è‡ªåŠ¨å¯ç”¨ io_uringï¼Ÿ

**A:** ä¸ºäº†å…¼å®¹æ€§å’Œç¨³å®šæ€§ï¼š
- ä¸æ˜¯æ‰€æœ‰ç³»ç»Ÿéƒ½æ”¯æŒ io_uring
- éœ€è¦ç”¨æˆ·æ˜ç¡®é€‰æ‹©é«˜æ€§èƒ½æ¨¡å¼
- ä¾¿äºé—®é¢˜æ’æŸ¥å’Œå›æ»š

### Q: å¯ä»¥çƒ­åˆ‡æ¢å—ï¼Ÿ

**A:** ä¸å¯ä»¥ï¼Œéœ€è¦é‡å¯æœåŠ¡ï¼š
```bash
# åœæ­¢
kill <pid>

# åˆ‡æ¢æ¨¡å¼é‡å¯
./server --use_iouring=true   # æˆ– false
```

### Q: io_uring ä¼šå¢åŠ  CPU ä½¿ç”¨å—ï¼Ÿ

**A:** é€šå¸¸ä¸ä¼šï¼Œåè€Œå¯èƒ½æ›´ä½ï¼š
- æ›´å°‘çš„ç³»ç»Ÿè°ƒç”¨ â†’ æ›´ä½çš„ CPU å¼€é”€
- æŸäº›åœºæ™¯ä¸‹å¯èƒ½ç•¥é«˜ï¼ˆç”¨ CPU æ¢å»¶è¿Ÿï¼‰
- æ€»ä½“æ•ˆç‡æ›´é«˜

---

## ğŸ“ è¿›é˜¶ä¸»é¢˜

### è‡ªå®šä¹‰é…ç½®

å¦‚æœéœ€è¦è°ƒæ•´æ‰¹é‡å‚æ•°ï¼Œä¿®æ”¹æºç ï¼š

```cpp
// src/brpc/event_dispatcher_iouring.cpp

// æ‰¹é‡æäº¤é˜ˆå€¼ï¼ˆé»˜è®¤ 8ï¼‰
const int BATCH_THRESHOLD = 16;  // å¢åŠ åˆ° 16

// CQE æ‰¹å¤„ç†å¤§å°ï¼ˆé»˜è®¤ 32ï¼‰
const int BATCH_SIZE = 64;       // å¢åŠ åˆ° 64

// é˜Ÿåˆ—æ·±åº¦ï¼ˆé»˜è®¤ 256ï¼‰
int ret = io_uring_queue_init(512, &ctx->ring, 0);  // å¢åŠ åˆ° 512
```

é‡æ–°ç¼–è¯‘åç”Ÿæ•ˆã€‚

### ç°åº¦å‘å¸ƒ

```bash
# é˜¶æ®µ 1ï¼š5% æµé‡
5% instances:  --use_iouring=true
95% instances: --use_iouring=false

# è§‚å¯Ÿ 3-7 å¤©

# é˜¶æ®µ 2ï¼š30% æµé‡
30% instances: --use_iouring=true
70% instances: --use_iouring=false

# è§‚å¯Ÿ 3-7 å¤©

# é˜¶æ®µ 3ï¼š100% æµé‡
100% instances: --use_iouring=true
```

### æ€§èƒ½è°ƒä¼˜æ¸…å•

- [ ] å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ï¼ˆulimit -n 65536ï¼‰
- [ ] è°ƒæ•´ TCP ç¼“å†²åŒºå¤§å°
- [ ] æ ¹æ®è´Ÿè½½è°ƒæ•´ bthread å¹¶å‘æ•°
- [ ] ç›‘æ§ CPU å’Œå†…å­˜ä½¿ç”¨
- [ ] ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·ï¼ˆperfï¼‰
- [ ] å¯¹æ¯” epoll æ¨¡å¼åŸºå‡†æµ‹è¯•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´ä½¿ç”¨æŒ‡å—](IOURING_USAGE_GUIDE.md) - è¯¦ç»†æ–‡æ¡£
- [ä¼˜åŒ–æ€»ç»“](IOURINGä¼˜åŒ–æ€»ç»“.md) - æ€§èƒ½ä¼˜åŒ–è¯´æ˜
- [å…¼å®¹æ€§æ£€æŸ¥](IOURING_5.10_å…¼å®¹æ€§ç¡®è®¤.md) - ç‰ˆæœ¬å…¼å®¹æ€§
- [æµ‹è¯•è¦†ç›–](IOURING_TEST_COVERAGE.md) - æµ‹è¯•è¯´æ˜

---

## ğŸ‰ æ€»ç»“

### ä¸‰æ­¥å¯ç”¨ io_uring

```bash
# 1. ç¼–è¯‘
cmake .. -DWITH_IO_URING=ON && make

# 2. è¿è¡Œ
./server --use_iouring=true

# 3. éªŒè¯
# çœ‹åˆ°æ—¥å¿—ï¼šio_uring EventDispatcher initialized successfully
```

### æ€§èƒ½æå‡é¢„æœŸ

- ğŸš€ ä½è´Ÿè½½ï¼š1.5-2x
- ğŸ“ˆ ä¸­ç­‰è´Ÿè½½ï¼š2-5x
- ğŸ”¥ é«˜è´Ÿè½½ï¼š3-10x

### ç«‹å³å¼€å§‹

```bash
# æ£€æŸ¥ç¯å¢ƒ
uname -r  # >= 5.10 ?
pkg-config --modversion liburing  # å·²å®‰è£… ?

# ç¼–è¯‘å¹¶è¿è¡Œ
cd brpc && mkdir build && cd build
cmake .. -DWITH_IO_URING=ON && make -j$(nproc)
./your_server --use_iouring=true --v=1

# äº«å—æ€§èƒ½æå‡ï¼ğŸ‰
```

---

**æœ‰é—®é¢˜ï¼ŸæŸ¥çœ‹ [å®Œæ•´ä½¿ç”¨æŒ‡å—](IOURING_USAGE_GUIDE.md) æˆ–æäº¤ Issueï¼**


